pipeline {
    agent any

    environment {
        REGISTRY = 'registry.lan:5000'
        IMAGE_NAME = 'backend'
        IMAGE_TAG = "${BUILD_NUMBER}"
        COMPOSE_PROJECT = '/home/pi/ci-cd-rpi'
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checking out code from SCM..."
                checkout scm
                sh 'cd backend && ls -la'
            }
        }

        stage('Test') {
            steps {
                dir('backend') {
                    echo "Skipping tests - tests run in Docker build stage"
                    echo "To run tests locally: pytest tests/ -v"
                }
            }
        }

        stage('Build Image') {
            steps {
                dir('backend') {
                    echo "Building Docker image..."
                    sh """
                        docker build -t ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} .
                        docker tag ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY}/${IMAGE_NAME}:latest
                    """
                }
            }
        }

        stage('Push to Registry') {
            steps {
                echo "Pushing images to local registry..."
                sh """
                    docker push ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                    docker push ${REGISTRY}/${IMAGE_NAME}:latest
                """
            }
        }

        stage('Deploy') {
            steps {
                echo "Deploying backend service..."
                sh """
                    # Pull the latest image
                    docker pull ${REGISTRY}/${IMAGE_NAME}:latest || true

                    # Stop and remove old container
                    docker stop backend || true
                    docker rm backend || true

                    # Start new container
                    docker run -d --name backend \
                        --network cicd-rpi_default \
                        -p 5001:5001 \
                        -e ENVIRONMENT=production \
                        ${REGISTRY}/${IMAGE_NAME}:latest
                """
            }
        }

        stage('Verify') {
            steps {
                echo "Verifying deployment..."
                sh '''
                    echo "Waiting for backend to be ready..."
                    sleep 10

                    echo "Testing health endpoint..."
                    curl -f http://localhost:5001/health || exit 1

                    echo "Testing API endpoint..."
                    curl -f http://localhost:5001/api/v1/hello || exit 1

                    echo "Backend is healthy!"
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Backend deployment successful!"
            echo "Build Number: ${BUILD_NUMBER}"
            echo "Image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        }
        failure {
            echo "❌ Backend deployment failed!"
            echo "Build Number: ${BUILD_NUMBER}"
            sh 'docker logs backend || true'
        }
        always {
            // Cleanup
            sh 'rm -rf backend/venv || true'
            cleanWs()
        }
    }
}
