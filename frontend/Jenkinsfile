pipeline {
    agent any

    environment {
        REGISTRY = 'registry.lan:5000'
        IMAGE_NAME = 'web'
        IMAGE_TAG = "${BUILD_NUMBER}"
        HOST_USER = 'pi'
        HOST_IP = '192.168.1.9'
        PROJECT_DIR = '/home/pi/ci-cd-rpi'
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checking out code from SCM..."
                checkout scm
                sh 'ls -la'
            }
        }

        stage('Build and Push') {
            steps {
                echo "Building and pushing image on host..."
                echo "This may take several minutes on first build..."
                sh """
                    ssh -o StrictHostKeyChecking=no ${HOST_USER}@${HOST_IP} '
                        cd ${PROJECT_DIR}/frontend
                        podman build -t ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} .
                        podman tag ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY}/${IMAGE_NAME}:latest
                        podman push ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                        podman push ${REGISTRY}/${IMAGE_NAME}:latest
                    '
                """
            }
        }

        stage('Deploy') {
            steps {
                echo "Deploying frontend service..."
                sh """
                    ssh -o StrictHostKeyChecking=no ${HOST_USER}@${HOST_IP} '
                        cd ${PROJECT_DIR}
                        podman-compose pull web
                        podman-compose up -d web
                    '
                """
            }
        }

        stage('Verify') {
            steps {
                echo "Verifying deployment..."
                sh '''
                    echo "Waiting for frontend to be ready..."
                    sleep 10

                    echo "Testing frontend..."
                    curl -f http://192.168.1.9:8082/ || exit 1

                    echo "Testing API proxy..."
                    curl -f http://192.168.1.9:8082/api/v1/hello || exit 1

                    echo "Frontend is accessible and API proxy is working!"
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Frontend deployment successful!"
            echo "Build Number: ${BUILD_NUMBER}"
            echo "Image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
            echo "Access at: http://192.168.1.9:8082/"
        }
        failure {
            echo "❌ Frontend deployment failed!"
            echo "Build Number: ${BUILD_NUMBER}"
        }
        always {
            cleanWs()
        }
    }
}
